#!/usr/bin/env php
<?php

function getDirContents($dir, &$results = []) {
	$files = scandir($dir);

	foreach ($files as $key => $value) {
		$path = realpath($dir . DIRECTORY_SEPARATOR . $value);
		if (!is_dir($path)) {
			$results[] = $path;
		}
        elseif ($value != "." && $value != "..") {
			getDirContents($path, $results);
//			$results[] = $path;
		}
	}

	return $results;
}

function deleteDir($dir) {
    if (!is_dir($dir)) {
        return false;
    }

    $files = scandir($dir);
    foreach ($files as $file) {
        if ($file === '.' || $file === '..') {
            continue;
        }

        $path = $dir . DIRECTORY_SEPARATOR . $file;

        if (is_dir($path)) {
            deleteDir($path);
        } else {
            unlink($path);
        }
    }

    return rmdir($dir);
}

function getWPTablePrefix() {
    $wpConfigPath = __DIR__ . '/../../../../wp-config.php';

    if (!is_readable($wpConfigPath)) {
        return null;
    }

    $content = file_get_contents($wpConfigPath);
    if ($content === false) {
        return null;
    }

    if (preg_match(
            '/\$table_prefix\s*=\s*[\'"]([^\'"]+)[\'"]\s*;/',
            $content,
            $matches
    )) {
        return $matches[1];
    }

    return null;
}

$wpTablePrefix     = getWPTablePrefix();
$projectDirName    = basename(dirname(__DIR__));
$projectName       = readline('Enter project name (Eg: My New Plugin): ');
$projectShortName  = readline('Enter project short name (Eg: mnp): ');
$rootNamespace     = readline('Enter project root namespace (Eg: MyNewPlugin): ');
$prefixEnv         = readline('Enter prefix for environment key (Eg: MNP_): ');
$textDomain        = readline('Enter text domain (Eg: my-new-plugin): ');
$prefixDBTable     = $projectShortName . '_';
$fullPrefixDBTable = $wpTablePrefix . $prefixDBTable;
$prefixHelpers     = $projectShortName . '_';
$time              = time();

if (!$projectDirName ||!$projectName || !$projectShortName || !$rootNamespace || !$prefixEnv || !$textDomain) {
	echo "\n";
	echo '[ERROR] Missing some information. Please try again!';
	echo "\n\n";
	exit();
}

/**
 * Delete .github folder.
 */
deleteDir(__DIR__ . '/../.github');

/**
 * Bulk replace "WPSP_".
 */
$filePaths = [
	'/../.env',
    '/../artisan',
	'/../Funcs.php',
];
foreach ($filePaths as $filePath) {
	$realPath   = __DIR__ . $filePath;
	$envContent = file_get_contents($realPath);
	$envContent = preg_replace('/WPSP_/', $prefixEnv, $envContent);
	file_put_contents($realPath, $envContent);
}

/**
 * Replace in WPSP.php
 */
$wpspContent = file_get_contents(__DIR__ . '/../WPSP.php');
$wpspContent = preg_replace('/namespace WPSP/', 'namespace ' . $rootNamespace, $wpspContent);
$wpspContent = preg_replace('/WPSP(?!CORE|\s|;|::)\\\/', $rootNamespace . '\\', $wpspContent);
$wpspContent = preg_replace('/WPSP_/', $prefixEnv, $wpspContent);
file_put_contents(__DIR__ . '/../WPSP.php', $wpspContent);

/**
 * Bulk replace namespaces.
 */
$filePaths = [];
$filePaths = array_merge($filePaths, getDirContents(__DIR__ . '/../app'));
$filePaths = array_merge($filePaths, getDirContents(__DIR__ . '/../config'));
$filePaths = array_merge($filePaths, getDirContents(__DIR__ . '/../database'));
$filePaths = array_merge($filePaths, getDirContents(__DIR__ . '/../routes'));
$filePaths = array_merge($filePaths, getDirContents(__DIR__ . '/../tests'));
$filePaths = array_merge($filePaths, [__DIR__ . '/../artisan']);
$filePaths = array_merge($filePaths, [__DIR__ . '/../composer.json']);
$filePaths = array_merge($filePaths, [__DIR__ . '/../Funcs.php']);
$filePaths = array_merge($filePaths, [__DIR__ . '/../ide.json']);
$filePaths = array_merge($filePaths, [__DIR__ . '/../bootstrap/app.php']);
$filePaths = array_merge($filePaths, [__DIR__ . '/../bootstrap/providers.php']);
foreach ($filePaths as $filePath) {
	$fileContent = file_get_contents($filePath);
    $fileContent = preg_replace('/namespace WPSP/', 'namespace ' . $rootNamespace, $fileContent);
	$fileContent = preg_replace('/"WPSP" requires/', '"' . $projectName . '" requires', $fileContent);
	$fileContent = preg_replace('/WPSP(?!CORE|\s|;|::)/', $rootNamespace, $fileContent);
	file_put_contents($filePath, $fileContent);
}

/**
 * Other replacements.
 */

// Replace in ".env" file.
$envContent = file_get_contents(__DIR__ . '/../.env');
$envContent = preg_replace('/APP_NAME="(.*?)"/', 'APP_NAME="' . $projectName . '"', $envContent);
$envContent = preg_replace('/APP_SHORT_NAME="(.*?)"/', 'APP_SHORT_NAME="' . $projectShortName . '"', $envContent);
$envContent = preg_replace('/DIR_NAME="(.*?)"/', 'DIR_NAME="' . $projectDirName . '"', $envContent);
$envContent = preg_replace('/DB_TABLE_PREFIX="(.*?)"/', 'DB_TABLE_PREFIX="' . $prefixDBTable . '"', $envContent);
$envContent = preg_replace('/CACHE_PREFIX="(.*?)"/', 'CACHE_PREFIX="' . $projectShortName . '-cache-"', $envContent);
$envContent = preg_replace('/REDIS_PREFIX="(.*?)"/', 'REDIS_PREFIX="' . $projectShortName . '_"', $envContent);
$envContent = preg_replace('/HORIZON_PREFIX="(.*?)"/', 'HORIZON_PREFIX="' . $projectShortName . '_horizon_"', $envContent);
$envContent = preg_replace('/MONGODB_DATABASE="(.*?)"/', 'MONGODB_DATABASE="' . $prefixDBTable . 'mongodb_database"', $envContent);
$envContent = preg_replace('/DB_CONNECTION="(.*?)"/', 'DB_CONNECTION="' . $wpTablePrefix . $projectShortName . '"', $envContent);
$envContent = preg_replace('/DB_QUEUE_CONNECTION="(.*?)"/', 'DB_QUEUE_CONNECTION="' . $wpTablePrefix . $projectShortName . '"', $envContent);
file_put_contents(__DIR__ . '/../.env', $envContent);

// Replace text domain.
$mainContent = file_get_contents(__DIR__ . '/../main.php');
$mainContent = preg_replace('/Plugin Name:(\s*)(.*?)\n/', "Plugin Name:$1" . $projectName . "\n", $mainContent);
$mainContent = preg_replace('/Description:(\s*)(.*?)\n/', "Description:$1" . $projectName . " using WordPress Starter Plugin\n", $mainContent);
$mainContent = preg_replace('/Text Domain:(\s*)(.*?)\n/', "Text Domain:$1" . $textDomain . "\n", $mainContent);
file_put_contents(__DIR__ . '/../main.php', $mainContent);

// Replace language files.
$potContent = file_get_contents(__DIR__ . '/../lang/wpsp.pot');
$potContent = preg_replace('/Project-Id-Version: (.*?)\\n/', 'Project-Id-Version: ' . $projectName . '\n', $potContent);
$potContent = preg_replace('/X-Domain: (.*?)"/', 'X-Domain: ' . $textDomain . '"', $potContent);
file_put_contents(__DIR__ . '/../lang/wpsp.pot', $potContent);
rename(__DIR__ . '/../lang/wpsp.pot', __DIR__ . '/../lang/' . $textDomain . '.pot');

$poContent = file_get_contents(__DIR__ . '/../lang/wpsp-vi.po');
$poContent = preg_replace('/Project-Id-Version: (.*?)\\n/', 'Project-Id-Version: ' . $projectName . '\n', $poContent);
$poContent = preg_replace('/X-Domain: (.*?)"/', 'X-Domain: ' . $textDomain . '"', $poContent);
file_put_contents(__DIR__ . '/../lang/wpsp-vi.po', $poContent);
rename(__DIR__ . '/../lang/wpsp-vi.po', __DIR__ . '/../lang/' . $textDomain . '-vi.po');

$l10nContent = file_get_contents(__DIR__ . '/../lang/wpsp-vi.l10n.php');
$l10nContent = preg_replace('/\'project-id-version\'=>\'(.+?)\'/', '\'project-id-version\'=>\'' . $projectName . '\'', $l10nContent);
$l10nContent = preg_replace('/\'x-domain\'=>\'(.+?)\'/', '\'x-domain\'=>\'' . $textDomain . '\'', $l10nContent);
file_put_contents(__DIR__ . '/../lang/wpsp-vi.l10n.php', $l10nContent);
rename(__DIR__ . '/../lang/wpsp-vi.l10n.php', __DIR__ . '/../lang/' . $textDomain . '-vi.l10n.php');

// Replace example migrations.
$migrationPaths = getDirContents(__DIR__ . '/../database/migrations');
foreach ($migrationPaths as $migrationPath) {
	$migrationContent = file_get_contents($migrationPath);
	$migrationContent = preg_replace('/wpsp_/', $prefixDBTable, $migrationContent);
	file_put_contents($migrationPath, $migrationContent);
}

// Replace config files.
foreach (getDirContents(__DIR__ . '/../config') as $configPath) {
    $configContent = file_get_contents($configPath);
    $configContent = preg_replace('/wpsp_/', $prefixDBTable, $configContent);
    $configContent = preg_replace('/wp_wpsp/', $wpTablePrefix . $projectShortName, $configContent);
    $configContent = preg_replace('/wpsp/', $projectShortName, $configContent);
    file_put_contents($configPath, $configContent);
}

// Replace in Models.
$modelPaths = getDirContents(__DIR__ . '/../app/Models');
foreach ($modelPaths as $modelPath) {
    $modelContent = file_get_contents($modelPath);
    $modelContent = preg_replace('/wpsp_/', $prefixDBTable, $modelContent);
    $modelContent = preg_replace('/wp_wpsp/', $wpTablePrefix . $projectShortName, $modelContent);
    $modelContent = preg_replace('/wpsp/', $projectShortName, $modelContent);
    file_put_contents($modelPath, $modelContent);
}

// Replace helper functions.
$helperContent = file_get_contents(__DIR__ . '/../app/Helpers/Helpers.php');
$helperContent = preg_replace('/wpsp_/', $prefixHelpers, $helperContent);
file_put_contents(__DIR__ . '/../app/Helpers/Helpers.php', $helperContent);

// Replace some views files.
$viewPaths = getDirContents(__DIR__ . '/../resources/views');
foreach ($viewPaths as $viewPath) {
	$viewContent = file_get_contents($viewPath);
	$viewContent = preg_replace('/wpsp_trans/', $prefixHelpers . 'trans', $viewContent);
	$viewContent = preg_replace('/wpsp_asset/', $prefixHelpers . 'asset', $viewContent);
	$viewContent = preg_replace('/wpsp_route/', $prefixHelpers . 'route', $viewContent);
	$viewContent = preg_replace('/wpsp_config/', $prefixHelpers . 'config', $viewContent);
	$viewContent = preg_replace('/wpsp_resources_path/', $prefixHelpers . 'resources_path', $viewContent);
	$viewContent = preg_replace('/wpsp_nonce_field/', $prefixHelpers . 'nonce_field', $viewContent);
	$viewContent = preg_replace('/wpsp_localize/', $prefixHelpers . 'localize', $viewContent);
	$viewContent = preg_replace('/WPSP\\\Funs/', $rootNamespace . '\Funcs', $viewContent);
	file_put_contents($viewPath, $viewContent);
}

// Replace autoloader suffix.
$composerContent = file_get_contents(__DIR__ . '/../composer.json');
$composerContent = preg_replace('/autoloader-suffix": "(.+?)"/', 'autoloader-suffix": "_' . $projectShortName . '_' . $time . '"', $composerContent);
$composerContent = preg_replace('/Helpers\.php/', $prefixEnv . 'Helpers_' . $time . '.php', $composerContent);
file_put_contents(__DIR__ . '/../composer.json', $composerContent);

// Rename helper files.
rename(__DIR__ . '/../app/Helpers/Helpers.php', __DIR__ . '/../app/Helpers/' . $prefixEnv . 'Helpers_' . $time . '.php');
$composerContent = preg_replace('/autoloader-suffix": "(.+?)"/', 'autoloader-suffix": "_' . $projectShortName . '_' . $time . '"', $composerContent);

// Replace in plugin.json
$pluginContent = file_get_contents(__DIR__ . '/../public/plugin.json');
$pluginContent = preg_replace('/name": "(.+?)"/', 'name": "' . $projectName . '"', $pluginContent);
file_put_contents(__DIR__ . '/../public/plugin.json', $pluginContent);

// Replace in Database.ts
$databaseContent = file_get_contents(__DIR__ . '/../resources/ts/web/admin-pages/wpsp/Database.ts');
$databaseContent = preg_replace('/wpsp_/', $projectShortName . '_', $databaseContent);
file_put_contents(__DIR__ . '/../resources/ts/web/admin-pages/wpsp/Database.ts', $databaseContent);

// Replace in resources/ts/web/admin-pages/admin.ts
$databaseContent = file_get_contents(__DIR__ . '/../resources/ts/web/admin-pages/admin.ts');
$databaseContent = preg_replace('/wpsp_/', $projectShortName . '_', $databaseContent);
file_put_contents(__DIR__ . '/../resources/ts/web/admin-pages/admin.ts', $databaseContent);

// Replace in Database.min.js
$databaseMinContent = file_get_contents(__DIR__ . '/../public/ts/web/admin-pages/wpsp/Database.min.js');
$databaseMinContent = preg_replace('/wpsp_/', $projectShortName . '_', $databaseMinContent);
file_put_contents(__DIR__ . '/../public/ts/web/admin-pages/wpsp/Database.min.js', $databaseMinContent);

// Replace in public/ts/web/admin-pages/admin.min.js
$databaseMinContent = file_get_contents(__DIR__ . '/../public/ts/web/admin-pages/admin.min.js');
$databaseMinContent = preg_replace('/wpsp_/', $projectShortName . '_', $databaseMinContent);
file_put_contents(__DIR__ . '/../public/ts/web/admin-pages/admin.min.js', $databaseMinContent);

// Replace in Ajaxs.php
$databaseContent = file_get_contents(__DIR__ . '/../routes/Ajaxs.php');
$databaseContent = preg_replace('/wpsp_handle_database/', $projectShortName . '_handle_database', $databaseContent);
file_put_contents(__DIR__ . '/../routes/Ajaxs.php', $databaseContent);

// Replace in ide.json
$ideContent = file_get_contents(__DIR__ . '/../ide.json');
$ideContent = preg_replace('/wpsp_/iu', $prefixHelpers, $ideContent);
file_put_contents(__DIR__ . '/../ide.json', $ideContent);

// Replace in app/WordPress/AdminPages/*
$tabUsersContent = file_get_contents(__DIR__ . '/../app/WordPress/AdminPages/wpsp/wpsp_tab_users.php');
$tabUsersContent = preg_replace('/wpsp_view_inject/iu', $prefixHelpers . 'view_inject', $tabUsersContent);
file_put_contents(__DIR__ . '/../app/WordPress/AdminPages/wpsp/wpsp_tab_users.php', $tabUsersContent);

// Messages.
echo "\n";
echo 'Installer is running...';
echo "\n\n";
echo 'Running "composer update"...';
echo "\n\n";

// Composer update.
exec('composer update');

echo "\n";
echo 'Running "php artisan route:remap"';
echo "\n\n";

// Remap routes.
exec('php artisan route:remap');

//echo "\n";
//echo 'Running "npm install"...';
//echo "\n\n";

// Install npm packages.
//exec('npm install --silent');

//echo "\n";
//echo 'Running "npm run mix-production"...';
//echo "\n\n";

// Mix.
//exec('npm run mix-production');

echo "\n";
echo 'Done! Your new plugin based on WPSP has been successfully installed.';
echo "\n\n";
echo 'Please go to /wp-admin > Plugin menu and then activate your new plugin: "' . $projectName . '"';
echo "\n\n";

exit();