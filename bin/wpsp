#!/usr/bin/env php
<?php
define('IS_CONSOLE', true);
require __DIR__ . '/../vendor/autoload.php';

use Symfony\Component\Console\Application;
use WPSP\app\Workers\Container\Container;
use WPSP\app\Workers\Database\Eloquent;
use WPSP\app\Workers\Database\Migration;
use WPSP\app\Workers\Environment\Environment;
use WPSP\app\Workers\Queue\Queue;
use WPSP\Funcs;
use WPSPCORE\Console\Kernel as ConsoleKernel;

try {
    /**
     * Environment.
     */
    Environment::init(__DIR__ . '/../');

    /**
     * Eloquent.
     */
    if (is_dir(__DIR__ . '/../vendor/oceancodex/wpsp-database')) {
        Eloquent::init();

        // Set event dispatcher for Eloquent models.
        $container = Container::instance();
        if ($container) {
            $useMongoDB = is_dir(__DIR__ . '/../vendor/oceancodex/wpsp-mongodb');
            Container::bootEvent($container, $useMongoDB);
        }
    }

    /**
     * Migration.
     */
    if (is_dir(__DIR__ . '/../vendor/oceancodex/wpsp-migration')) {
        Migration::init();
    }


    /**
     * Queue.
     */
    if (is_dir(__DIR__ . '/../vendor/oceancodex/wpsp-queue')) {
        Queue::init();
    }

    /**
     * Define variables.
     */
    $application   = new Application();
    $mainPath      = Funcs::instance()->_getMainPath();
    $rootNamespace = Funcs::instance()->_getRootNamespace();
    $prefixEnv     = Funcs::instance()->_getPrefixEnv();

    /**
     * Init vendor commands.
     */
    ConsoleKernel::initCommands(
        $mainPath,
        $rootNamespace,
        $prefixEnv,
        [
            'funcs'       => Funcs::instance(),
            'application' => $application,
        ]
    );

    /**
     * Your custom commands define below here.
     */
    $customCommands = Funcs::config('commands');

    /**
     * Add custom commands to application.
     */
    foreach ($customCommands as $customCommand) {
        if ($customCommand) $application->add(new $customCommand($mainPath, $rootNamespace, $prefixEnv, [
                'funcs'       => Funcs::instance(),
                'application' => $application,
        ]));
    }

    /**
     * Run application.
     */
    $application->run();
}
catch (Exception $e) {
    Funcs::debug($e, true);
    die($e->getMessage());
}